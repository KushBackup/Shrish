<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Death by Design: Pixel Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #202020; 
            font-family: 'VT323', monospace; 
        }
        
        /* The Game Canvas - Low Res Scaled Up */
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            image-rendering: pixelated; /* Essential for pixel art look */
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .pointer-events-auto { pointer-events: auto; }
        
        /* Pixel Art UI Styling */
        .pixel-border { 
            border: 4px solid white; 
            box-shadow: 4px 4px 0px black; 
            background: #2a2a2a; 
            color: white;
        }
        
        .btn { 
            background: #ff3366; color: white; border: 2px solid white; padding: 10px 20px; 
            cursor: pointer; transition: transform 0.1s; font-size: 1.5rem; text-transform: uppercase;
            letter-spacing: 2px; box-shadow: 4px 4px 0px rgba(0,0,0,0.5);
            text-shadow: 2px 2px 0px black;
        }
        .btn:hover { transform: translate(-2px, -2px); background: #ff5588; }
        .btn:active { transform: translate(0, 0); box-shadow: none; }
        
        .dialogue-box {
            background: rgba(0, 0, 0, 0.9);
            border: 4px solid white;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.5);
        }

        /* CRT Scanline effect overlay */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; z-index: 50;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- 2D Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- CRT Effect -->
    <div class="scanlines"></div>

    <!-- UI Layer -->
    <div id="ui-layer" class="z-10 p-4 md:p-8">
        
        <!-- Header -->
        <div class="flex justify-between items-start w-full pointer-events-auto">
            <div class="pixel-border p-4">
                <h1 class="text-4xl leading-none text-yellow-400 drop-shadow-md">DEATH BY DESIGN</h1>
                <p class="text-lg text-gray-300">PIXEL EDITION ‚Ä¢ GOA</p>
            </div>
            <button onclick="toggleRulebook()" class="btn text-xl">üìí RULES</button>
        </div>

        <!-- Notification Area -->
        <div id="notification" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-900 text-white p-6 border-4 border-white shadow-2xl text-center z-50 pointer-events-auto max-w-md w-full">
            <h2 id="notif-title" class="text-3xl mb-2 text-yellow-300"></h2>
            <p id="notif-body" class="mb-6 text-xl leading-relaxed"></p>
            <button onclick="closeNotification()" class="btn w-full">CONTINUE</button>
        </div>

        <!-- Interaction Prompt -->
        <div id="interaction-prompt" class="hidden absolute top-2/3 left-1/2 transform -translate-x-1/2 bg-black text-white border-2 border-white px-4 py-2 pointer-events-auto shadow-lg text-xl">
            Click to Inspect
        </div>

        <!-- Dialogue/Story Box (Bottom) -->
        <div id="dialogue-container" class="w-full max-w-4xl mx-auto mb-4 pointer-events-auto hidden">
            <div class="dialogue-box p-6 flex flex-col md:flex-row gap-4 items-start text-white">
                <div class="w-full md:w-3/4">
                    <h3 id="speaker-name" class="text-2xl text-yellow-400 mb-2 uppercase border-b-2 border-gray-600 inline-block">UNKNOWN</h3>
                    <p id="dialogue-text" class="text-2xl leading-relaxed mb-4">...</p>
                    
                    <!-- Choices -->
                    <div id="choices-area" class="grid grid-cols-1 gap-2">
                        <!-- Buttons injected via JS -->
                    </div>
                </div>
                <div class="w-full md:w-1/4 flex flex-col gap-2 border-l-2 border-gray-600 pl-4">
                    <div class="text-sm text-gray-400 uppercase">Suspects</div>
                    <div id="suspect-count" class="text-5xl text-red-400">9</div>
                    <div class="text-sm text-gray-400 uppercase mt-2">Clues</div>
                    <div id="clue-count" class="text-5xl text-cyan-400">0/5</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen" class="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-4 pointer-events-auto">
        <div class="max-w-2xl w-full border-4 border-white p-8 bg-gray-800 text-white text-center">
            <h1 class="text-8xl mb-4 text-yellow-400" style="text-shadow: 4px 4px #ff3366;">DEATH BY DESIGN</h1>
            <p class="text-2xl mb-8 text-cyan-300">8-BIT MURDER MYSTERY</p>
            
            <div class="text-left bg-black p-4 border-2 border-gray-600 mb-8 text-lg space-y-2 font-mono text-green-400">
                <p>> CRIME: MURDER</p>
                <p>> VICTIM: MR. CRITICUS</p>
                <p>> LOCATION: SWITCH & ROY STUDIO</p>
                <p>> STATUS: UNRESOLVED</p>
            </div>

            <button onclick="startGame()" class="btn text-3xl w-full py-4 animate-pulse">START STORY</button>
        </div>
    </div>

    <!-- Rulebook Modal -->
    <div id="rulebook-modal" class="hidden fixed inset-0 z-[60] bg-black bg-opacity-90 flex items-center justify-center p-4 pointer-events-auto">
        <div class="bg-gray-800 text-white max-w-lg w-full border-4 border-white p-6 relative shadow-2xl">
            <button onclick="toggleRulebook()" class="absolute top-2 right-2 text-3xl hover:text-red-500">&times;</button>
            <h2 class="text-4xl mb-4 text-yellow-400 border-b-4 border-white inline-block">RULE BOOK</h2>
            
            <div class="space-y-6 text-xl">
                <div class="p-2">
                    <h3 class="text-cyan-400 mb-1">> THE GOAL</h3>
                    <p>Work together. Point and Click to explore the studio. Read everything out loud.</p>
                </div>

                <div class="p-2 border-l-4 border-pink-500 bg-gray-900">
                    <h3 class="text-pink-500 mb-1">> DRINKING RULES üçª</h3>
                    <ul class="list-disc list-inside text-lg text-gray-300">
                        <li>Drink if someone says "Make it bigger".</li>
                        <li>Drink if a clue mentions "Comic Sans".</li>
                        <li>Drink if you find a Red Herring.</li>
                        <li>Finish drink if you accuse the WRONG person.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- GAME CONFIGURATION ---
        const CANVAS_WIDTH = 400; // Internal Low Res Width
        const CANVAS_HEIGHT = 300; // Internal Low Res Height
        
        const state = {
            cluesFound: 0,
            totalClues: 5,
            gameActive: false,
            currentPhase: 'story', // story, investigation, accusation, end
            storyIndex: 0,
            evidence: [],
            suspects: [
                { id: 'shristhi', name: 'Shristhi', role: 'Graphic Designer', color: '#FF69B4', alibi: "I was manually kerning a headline. Do you know how long that takes?", suspicious: "She's holding an X-Acto knife very tightly." },
                { id: 'taher', name: 'Taher', role: 'Illustrator', color: '#32CD32', alibi: "I was washing my brushes. Do you know how hard Indian Ink is to remove?", suspicious: "His hands are stained black. Is that ink... or dried blood?" },
                { id: 'tejas', name: 'Tejas', role: 'Writer/Filmmaker', color: '#A9A9A9', alibi: "I was writing a plot twist for the brand film script.", suspicious: "He's looking at the body like it's a scene composition." },
                { id: 'swikriti', name: 'Swikriti', role: 'Motion Graphics', color: '#9370DB', alibi: "I was tweaking the graph editor. One wrong click and the animation breaks.", suspicious: "Her hands are twitching like she's spamming Ctrl+Z." },
                { id: 'namya', name: 'Namya', role: 'UI/UX Designer', color: '#00BFFF', alibi: "I was wireframing a user flow. The user died at step 3. Metaphorically.", suspicious: "She said the victim had 'terrible affordance'." },
                { id: 'isha', name: 'Isha', role: 'Graphic Designer', color: '#FFA500', alibi: "I was vectorizing a pixelated logo the client sent in a Word doc.", suspicious: "She looks ready to delete someone's layer." },
                { id: 'kush', name: 'Kush', role: 'Game Designer', color: '#DC143C', alibi: "I was debugging a collision mesh in the level editor.", suspicious: "He keeps mumbling about 'hitboxes'." },
                { id: 'upasana', name: 'Upasana', role: 'Founder', color: '#FFD700', alibi: "I was calculating our taxes. Scarier than murder.", suspicious: "The victim gave Switch a bad review." },
                { id: 'roy', name: 'Roy', role: 'Founder', color: '#C0C0C0', alibi: "I was fixing the WiFi router. Again.", suspicious: "Was heard yelling 'No more changes!' earlier." }
            ]
        };

        // --- NARRATIVE DATA ---
        const storyLines = [
            {
                speaker: "Narrator",
                text: "Thunder rumbles over Goa. It's 3 AM at Switch & Roy Studio. The air is thick with tension, humidity, and the smell of stale coffee."
            },
            {
                speaker: "Narrator",
                text: "Mr. Criticus, the legendary (and hated) design critic, had arrived unannounced to 'review' the team's work. It was a bloodbath."
            },
            {
                speaker: "Narrator",
                text: "He told Shristhi and Isha their typography was 'criminal'. He told Namya the user journey was 'a road to nowhere'."
            },
            {
                speaker: "Narrator",
                text: "He laughed at Taher's illustrations, called Kush's level design 'flat', and told Tejas his script lacked drama."
            },
            {
                speaker: "Narrator",
                text: "Then he turned to Swikriti. 'Your motion graphics,' he sneered, 'are as stiff as a corpse. No flow. No soul.'"
            },
            {
                speaker: "Narrator",
                text: "Upasana and Roy tried to intervene, but the power suddenly cut. Darkness. A scream. A loud CRUNCH."
            },
            {
                speaker: "Narrator",
                text: "When the generator kicked in, Criticus was gone. Flattened under a 'Best Design' award. The police are stuck in traffic. It's up to you."
            }
        ];

        // --- CANVAS ENGINE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Disable smoothing for pixel art look
        ctx.imageSmoothingEnabled = false;

        let entities = [];
        let mouseX = 0;
        let mouseY = 0;
        let hoveredEntity = null;
        let rainDrops = []; // Array for rain animation

        // Setup Canvas Resolution
        function resize() {
            // We keep internal resolution low (320x240) but scale with CSS
            canvas.width = CANVAS_WIDTH;
            canvas.height = CANVAS_HEIGHT;
            ctx.imageSmoothingEnabled = false;
        }
        window.addEventListener('resize', resize);
        resize();

        // --- RAIN SYSTEM ---
        for(let i=0; i<50; i++) {
            rainDrops.push({
                x: Math.random() * CANVAS_WIDTH,
                y: Math.random() * CANVAS_HEIGHT,
                speed: Math.random() * 5 + 5
            });
        }

        // --- ENTITY SYSTEM ---
        class Entity {
            constructor(x, y, width, height, type, color, data) {
                this.x = x;
                this.y = y;
                this.width = width;
                this.height = height;
                this.type = type; // 'suspect', 'clue', 'decor'
                this.color = color;
                this.data = data;
                this.baseY = y;
                this.animOffset = Math.random() * 100;
            }

            draw(ctx, time) {
                let drawY = this.y;
                
                // Bounce animation for interactables
                if (this.type !== 'decor') {
                    drawY += Math.sin(time * 0.005 + this.animOffset) * 2;
                }

                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(this.x + 2, this.y + this.height - 2, this.width, 4);

                // Main Body
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, drawY, this.width, this.height);

                // Details based on type
                if (this.type === 'suspect') {
                    // Head
                    ctx.fillStyle = '#ffccaa'; // Skin tone
                    ctx.fillRect(this.x + 4, drawY - 12, 12, 12);
                    // Hair (matching body color usually)
                    ctx.fillStyle = this.color; 
                    ctx.fillRect(this.x + 2, drawY - 14, 16, 4);
                } 
                else if (this.type === 'clue') {
                    // Question mark or highlight
                    ctx.fillStyle = 'white';
                    ctx.fillRect(this.x + this.width/2 - 1, drawY + 2, 2, 2);
                }

                // Hover Outline
                if (hoveredEntity === this && state.currentPhase === 'investigation') {
                    ctx.strokeStyle = 'white';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(this.x - 2, drawY - (this.type==='suspect'?14:2), this.width + 4, this.height + (this.type==='suspect'?14:4));
                    
                    // Name Tag
                    ctx.fillStyle = 'black';
                    ctx.fillRect(this.x + this.width/2 - 20, drawY - 30, 40, 10);
                    ctx.fillStyle = 'white';
                    ctx.font = '10px "VT323"';
                    ctx.textAlign = 'center';
                    const name = this.data.name || this.data.id || "Object";
                    ctx.fillText(name, this.x + this.width/2, drawY - 22);
                }
            }
        }

        function initGameWorld() {
            entities = [];

            // Room Setup (Implicitly drawn in render loop)

            // 1. Furniture (Decor)
            // Large Conference Table
            entities.push(new Entity(100, 150, 200, 60, 'decor', '#8B4513', {})); 
            
            // Desks with Computers
            const deskColor = '#A0522D';
            entities.push(new Entity(20, 80, 40, 30, 'decor', deskColor, {}));
            entities.push(new Entity(340, 80, 40, 30, 'decor', deskColor, {}));
            entities.push(new Entity(20, 220, 40, 30, 'decor', deskColor, {}));
            entities.push(new Entity(340, 220, 40, 30, 'decor', deskColor, {}));

            // 2. Clues
            // Tejas's Computer
            entities.push(new Entity(25, 70, 20, 15, 'clue', '#ADD8E6', {
                id: "computer_tejas",
                name: "PC (Tejas)",
                text: "Tejas's Screen: A script document titled 'The Murder'. Wait, that's just a film concept... right?",
                isCritical: false
            }));
            
            // Taher's Computer - UPDATED for Illustrator Role
            entities.push(new Entity(345, 70, 20, 15, 'clue', '#FF0000', {
                id: "computer_taher",
                name: "Tablet (Taher)",
                text: "Taher's Cintiq. A half-finished drawing of a demon. It looks... suspiciously like the victim.",
                isCritical: false
            }));

            // Shristhi's Computer
            entities.push(new Entity(25, 210, 20, 15, 'clue', '#FF69B4', {
                id: "computer_shristhi",
                name: "PC (Shristhi)",
                text: "Shristhi's Screen: A Pinterest board titled 'Deadly Aesthetics'. Suspicious or just design research?",
                isCritical: false
            }));

            // The Weapon (Award)
            entities.push(new Entity(180, 140, 10, 20, 'clue', '#FFD700', {
                id: "weapon",
                name: "Award",
                text: "A heavy 'Best Design 2024' award. The corner is covered in... ketchup? No, blood. It belongs to Roy Studio.",
                isCritical: true
            }));

            // Spilled Coffee
            entities.push(new Entity(120, 160, 12, 8, 'clue', '#6F4E37', {
                id: "coffee",
                name: "Coffee",
                text: "A spilled artisanal latte. Soy milk, double shot. Only Namya (UX) drinks this specific abomination.",
                isCritical: true
            }));

            // Sketchbook
            entities.push(new Entity(260, 160, 15, 10, 'clue', '#F0E68C', {
                id: "sketchbook",
                name: "Sketchbook",
                text: "Swikriti's storyboard sketch. The victim is drawn falling into a void. Caption: 'Bad Physics'.",
                isCritical: true
            }));

            // Rejection Letter
            entities.push(new Entity(350, 230, 10, 8, 'clue', '#FFFFFF', {
                id: "letter",
                name: "Letter",
                text: "A letter from the victim to Upasana. 'Your designs lack soul and the kerning is offensive.' Ouch.",
                isCritical: true
            }));

            // Pizza Box (Red Herring)
            entities.push(new Entity(300, 250, 20, 20, 'clue', '#FFA500', {
                id: "pizza",
                name: "Pizza Box",
                text: "An empty pizza box from last night. Just crumbs and regret. (DRINK!)",
                isCritical: false,
                drink: true
            }));

            // Broken Stylus
            entities.push(new Entity(50, 250, 5, 15, 'clue', '#808080', {
                id: "stylus",
                name: "Stylus",
                text: "A broken Wacom pen tip. Someone was pressing VERY hard. Kush (Game Design) was complaining about his stylus earlier.",
                isCritical: true
            }));
            
            // The Body (Chalk Outline)
            entities.push(new Entity(200, 100, 30, 10, 'decor', '#333', {}));

            // 3. Suspects (Arrange them in a circle around the room)
            const centerX = 200;
            const centerY = 150;
            const radius = 120;
            
            state.suspects.forEach((sus, i) => {
                const angle = (i / state.suspects.length) * Math.PI * 2;
                const x = centerX + Math.cos(angle) * radius - 10;
                const y = centerY + Math.sin(angle) * (radius * 0.8) - 20; // Oval shape layout
                
                entities.push(new Entity(x, y, 20, 30, 'suspect', sus.color, sus));
            });

            // Sort by Y for depth
            entities.sort((a, b) => a.y - b.y);
        }

        // --- INPUT HANDLING ---
        canvas.addEventListener('mousemove', (e) => {
            if (!state.gameActive || state.currentPhase === 'story') return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = CANVAS_WIDTH / rect.width;
            const scaleY = CANVAS_HEIGHT / rect.height;
            
            mouseX = (e.clientX - rect.left) * scaleX;
            mouseY = (e.clientY - rect.top) * scaleY;

            // Check hover
            hoveredEntity = null;
            // Iterate backwards to click top-most items first
            for (let i = entities.length - 1; i >= 0; i--) {
                const ent = entities[i];
                if (ent.type === 'decor') continue;
                
                // Simple AABB collision
                // Hitbox slightly larger for easier clicking
                if (mouseX >= ent.x - 5 && mouseX <= ent.x + ent.width + 5 &&
                    mouseY >= ent.y - 15 && mouseY <= ent.y + ent.height + 5) {
                    hoveredEntity = ent;
                    break;
                }
            }

            const prompt = document.getElementById('interaction-prompt');
            if (hoveredEntity) {
                canvas.style.cursor = 'pointer';
                prompt.classList.remove('hidden');
                const name = hoveredEntity.data.name || "Object";
                prompt.innerText = `Inspect ${name}`;
            } else {
                canvas.style.cursor = 'default';
                prompt.classList.add('hidden');
            }
        });

        canvas.addEventListener('click', () => {
            if (!state.gameActive) return;
            // If in story mode, we don't interact with entities
            if (state.currentPhase === 'story') return;
            
            if (hoveredEntity) {
                handleInteraction(hoveredEntity);
            }
        });

        // --- RENDER LOOP ---
        function loop(time) {
            if (!state.gameActive) return;
            
            // Clear
            ctx.fillStyle = '#202020';
            ctx.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

            // Draw Rain (Outside Effect)
            ctx.strokeStyle = '#445588';
            ctx.lineWidth = 1;
            ctx.beginPath();
            rainDrops.forEach(drop => {
                drop.y += drop.speed;
                if(drop.y > CANVAS_HEIGHT) drop.y = -10;
                ctx.moveTo(drop.x, drop.y);
                ctx.lineTo(drop.x, drop.y + 5);
            });
            ctx.stroke();

            // Draw Floor
            ctx.fillStyle = '#444';
            ctx.fillRect(10, 10, CANVAS_WIDTH - 20, CANVAS_HEIGHT - 20);
            
            // Draw Grid/Tiles
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 1;
            for(let x=10; x<CANVAS_WIDTH-10; x+=40) {
                ctx.beginPath(); ctx.moveTo(x, 10); ctx.lineTo(x, CANVAS_HEIGHT-10); ctx.stroke();
            }
            for(let y=10; y<CANVAS_HEIGHT-10; y+=40) {
                ctx.beginPath(); ctx.moveTo(10, y); ctx.lineTo(CANVAS_WIDTH-10, y); ctx.stroke();
            }

            // Draw "Walls"
            ctx.strokeStyle = '#FFF';
            ctx.lineWidth = 4;
            ctx.strokeRect(10, 10, CANVAS_WIDTH - 20, CANVAS_HEIGHT - 20);

            // Draw Entities (Sorted by Y)
            entities.sort((a, b) => a.y - b.y);
            entities.forEach(ent => ent.draw(ctx, time));

            requestAnimationFrame(loop);
        }

        // --- GAME LOGIC ---

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('dialogue-container').classList.remove('hidden');
            state.gameActive = true;
            state.currentPhase = 'story';
            state.storyIndex = 0;
            initGameWorld();
            requestAnimationFrame(loop);
            
            // Start Story
            showNextStoryBeat();
        }

        function showNextStoryBeat() {
            if (state.storyIndex < storyLines.length) {
                const beat = storyLines[state.storyIndex];
                // Show dialogue with a "Next" button
                showDialogue(beat.speaker, beat.text, ["Next"]);
            } else {
                // Story Over, Begin Game
                state.currentPhase = 'investigation';
                showDialogue("Narrator", "The studio is silent now. Find 5 clues to expose the killer.", ["Start Investigation"]);
            }
        }

        function handleInteraction(entity) {
            if (state.currentPhase !== 'investigation') return;

            const data = entity.data;

            if (entity.type === 'clue') {
                if (data.drink) {
                    showNotification("DRINK! üç∫", data.text + " (Red Herring!)");
                } else if (state.evidence.includes(data.id)) {
                    showNotification("Already Inspected", "You've already noted this clue.");
                } else {
                    state.evidence.push(data.id);
                    if (data.isCritical) {
                        state.cluesFound++;
                        updateHUD();
                        showNotification("CLUE FOUND üîé", data.text);
                        
                        if (state.cluesFound >= state.totalClues) {
                             // Dramatic Pause before Accusation
                             setTimeout(() => {
                                 showDialogue("Narrator", "That's the final clue! The evidence is clear. The team gathers in the center room. The storm rages outside. It's time to name the killer.", ["Gather Everyone"]);
                             }, 1500);
                        }
                    } else {
                        showNotification("Interesting...", data.text);
                    }
                }
            } else if (entity.type === 'suspect') {
                showDialogue(data.name, `"${data.alibi}"`, [`Ask about suspicious behavior`]);
                state.activeSuspect = data;
            }
        }

        function updateHUD() {
            document.getElementById('clue-count').innerText = `${state.cluesFound}/${state.totalClues}`;
            if (state.cluesFound >= state.totalClues) {
                document.getElementById('clue-count').classList.add('text-red-500');
            }
        }

        function showDialogue(speaker, text, choices) {
            const box = document.getElementById('dialogue-container');
            box.classList.remove('hidden');
            document.getElementById('speaker-name').innerText = speaker;
            document.getElementById('dialogue-text').innerText = text;
            
            const choicesDiv = document.getElementById('choices-area');
            choicesDiv.innerHTML = '';

            choices.forEach(choice => {
                const btn = document.createElement('button');
                btn.className = "btn text-left text-lg w-full";
                btn.innerText = `> ${choice}`;
                btn.onclick = () => handleChoice(choice);
                choicesDiv.appendChild(btn);
            });
        }

        function handleChoice(choice) {
            if (choice === "Next") {
                state.storyIndex++;
                showNextStoryBeat();
            }
            else if (choice === "Start Investigation" || choice === "Back to investigation") {
                document.getElementById('dialogue-container').classList.add('hidden');
            } 
            else if (choice === "Ask about suspicious behavior") {
                showDialogue(state.activeSuspect.name, `(Nervously) "Okay, fine! ${state.activeSuspect.suspicious}"`, ["Back to investigation"]);
            }
            else if (choice === "Accuse Someone" || choice === "Gather Everyone") {
                renderAccusationUI();
            }
        }

        function renderAccusationUI() {
            state.currentPhase = 'accusation';
            const box = document.getElementById('dialogue-container');
            box.classList.remove('hidden');
            document.getElementById('speaker-name').innerText = "FINAL VOTE";
            document.getElementById('dialogue-text').innerText = "Who killed Mr. Criticus? discuss your theories with the room, then cast your vote.";
            
            const choicesDiv = document.getElementById('choices-area');
            choicesDiv.innerHTML = '';
            choicesDiv.className = "grid grid-cols-3 gap-2 mt-4";

            state.suspects.forEach(sus => {
                const btn = document.createElement('button');
                btn.className = "btn text-sm bg-gray-700 border-gray-500";
                btn.style.backgroundColor = sus.color;
                btn.style.color = 'black';
                btn.innerText = sus.name.toUpperCase();
                btn.onclick = () => resolveGame(sus.id);
                choicesDiv.appendChild(btn);
            });
        }

        function resolveGame(accusedId) {
            const killerId = 'swikriti';
            document.getElementById('dialogue-container').classList.add('hidden');
            let title, body, btnText;

            if (accusedId === killerId) {
                title = "CASE SOLVED! üéâ";
                body = "It was Swikriti! She snaps under the pressure. <br><br> 'He said my easing was LINEAR! Do I look like a default preset?!' she screams. The police arrive just in time. The studio is safe... for now.";
                btnText = "Play Again";
            } else {
                title = "WRONG SUSPECT! üíÄ";
                body = `You accused ${state.suspects.find(s=>s.id===accusedId).name}. They are shocked and innocent! <br><br> In the confusion, Swikriti slips out the back door into the rain. The killer escapes. <br><br><strong>EVERYONE FINISH YOUR DRINK!</strong>`;
                btnText = "Try Again";
            }

            const notif = document.getElementById('notification');
            notif.classList.remove('hidden');
            notif.style.top = '50%';
            document.getElementById('notif-title').innerHTML = title;
            document.getElementById('notif-body').innerHTML = body;
            notif.querySelector('button').innerText = btnText;
            notif.querySelector('button').onclick = () => location.reload();
        }

        function showNotification(title, body) {
            const notif = document.getElementById('notification');
            notif.classList.remove('hidden');
            document.getElementById('notif-title').innerText = title;
            document.getElementById('notif-body').innerText = body;
        }

        function closeNotification() {
            document.getElementById('notification').classList.add('hidden');
        }

        function toggleRulebook() {
            const el = document.getElementById('rulebook-modal');
            el.classList.toggle('hidden');
        }
    </script>
</body>
</html>